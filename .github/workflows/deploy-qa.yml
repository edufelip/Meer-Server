name: Deploy Dev

on:
  push:
    branches: [ develop ]

jobs:
  migrate-and-deploy:
    concurrency:
      group: deploy-dev
      cancel-in-progress: true
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decode and load env from base64 secret
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${{ secrets.DEV_ENV_FILE_B64 }}" ]; then
            echo "Missing required secret: DEV_ENV_FILE_B64" >&2
            exit 1
          fi

          echo "${{ secrets.DEV_ENV_FILE_B64 }}" | tr -d '\r\n\t ' | base64 --decode > .env
          sed \
            -e '/^FIREBASE_ENABLED=/d' \
            -e '/^FIREBASE_PROJECT_ID=/d' \
            -e '/^FIREBASE_CREDENTIALS_PATH=/d' \
            .env > .env.cleaned
          mv .env.cleaned .env
          cat >> .env <<'EOF'
          FIREBASE_ENABLED=true
          FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
          GOOGLE_APPLICATION_CREDENTIALS=/opt/meer-dev/firebase-service-account.json
          STORAGE_GCS_CREDENTIALS_PATH=/opt/meer-dev/gcs-service-account.json
          EOF

          while IFS= read -r line || [ -n "$line" ]; do
            line="${line#"${line%%[![:space:]]*}"}"
            line="${line%"${line##*[![:space:]]}"}"

            [ -z "$line" ] && continue
            case "$line" in
              \#*) continue ;;
            esac

            case "$line" in
              *=*)
                key="${line%%=*}"
                val="${line#*=}"
                key="${key#"${key%%[![:space:]]*}"}"
                key="${key%"${key##*[![:space:]]}"}"
                printf '%s=%s\n' "$key" "$val" >> "$GITHUB_ENV"
                ;;
              *)
                echo "Invalid line in decoded env file: $line" >&2
                exit 1
                ;;
            esac
          done < .env

      - name: Fail if required vars are missing
        shell: bash
        run: |
          set -euo pipefail
          required=(
            DB_HOST DB_PORT DB_NAME DB_USER DB_PASSWORD
            SPRING_PROFILES_ACTIVE
            SECURITY_JWT_SECRET SECURITY_JWT_ACCESS_TTL_MINUTES SECURITY_JWT_REFRESH_TTL_DAYS
            GOOGLE_ANDROID_CLIENT_ID GOOGLE_IOS_CLIENT_ID GOOGLE_WEB_CLIENT_ID
            FIREBASE_ENABLED FIREBASE_PROJECT_ID GOOGLE_APPLICATION_CREDENTIALS
            GCS_BUCKET GCS_PUBLIC_BASE_URL GCS_SIGNED_URL_TTL_MINUTES GCS_AVATARS_PREFIX
            MEER_CORS_ALLOWED_ORIGINS
            SERVICE REMOTE_JAR HEALTH_URL
          )

          missing=()
          for k in "${required[@]}"; do
            v="$(printenv "$k" || true)"
            [ -n "$v" ] || missing+=("$k")
          done

          if [ ${#missing[@]} -ne 0 ]; then
            echo "Missing required vars: ${missing[*]}" >&2
            exit 1
          fi

      - name: Set build version
        run: echo "SHA_SHORT=${GITHUB_SHA::7}" >> "$GITHUB_ENV"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Pre-cleanup disk on dev host (before Flyway)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            sudo apt-get clean || true
            sudo rm -rf /root/.gradle/caches /root/.gradle/wrapper || true
            sudo find /tmp -mindepth 1 -mtime +1 -exec rm -rf {} + || true
            sudo journalctl --vacuum-time=7d --vacuum-size=100M || true
            sudo logrotate -f /etc/logrotate.conf || true
            sudo gzip -f /var/log/syslog.1 2>/dev/null || true
            df -h / /tmp /var || true

      - name: Run Flyway migrations on dev DB
        run: ./gradlew :springboot:flywayMigrate

      - name: Flyway info (out-of-order check)
        run: ./gradlew :springboot:flywayInfo

      - name: Build jar
        run: ./gradlew :springboot:bootJar

      - name: Rename jar with version
        run: mv springboot/build/libs/meer-*.jar springboot/build/libs/meer-${{ env.SHA_SHORT }}.jar

      - name: Cleanup old backups and tmp on dev host
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            sudo rm -rf /opt/meer-dev/meer.jar.bak.* /tmp/meer-*.jar /tmp/.env /tmp/.env/.env || true
            sudo apt-get clean || true
            sudo journalctl --vacuum-time=7d --vacuum-size=100M || true
            sudo logrotate -f /etc/logrotate.conf || true
            sudo gzip -f /var/log/syslog.1 2>/dev/null || true
            df -h / /tmp /var || true

      - name: Copy jar to dev host
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: springboot/build/libs/meer-${{ env.SHA_SHORT }}.jar
          target: /tmp
          strip_components: 3

      - name: Copy runtime .env to dev host
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: .env
          target: /tmp

      - name: Restart service on dev
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            # Ensure the runtime env file is in place first
            if [ -f /tmp/.env ]; then
              sudo mv /tmp/.env /opt/meer-dev/.env
              sudo chown meerdev:meerdev /opt/meer-dev/.env
              sudo chmod 600 /opt/meer-dev/.env
            fi

            # Backup current jar
            if [ -f "${{ env.REMOTE_JAR }}" ]; then
              sudo cp "${{ env.REMOTE_JAR }}" "${{ env.REMOTE_JAR }}.bak"
            fi

            # Deploy new jar
            sudo mv "/tmp/meer-${{ env.SHA_SHORT }}.jar" "${{ env.REMOTE_JAR }}"
            sudo chown meerdev:meerdev "${{ env.REMOTE_JAR }}"

            # Source env locally for this script
            if sudo test -f /opt/meer-dev/.env; then
              set -a
              source <(sudo cat /opt/meer-dev/.env)
              set +a
            fi

            # Update systemd env
            sudo mkdir -p /etc/systemd/system/"${{ env.SERVICE }}".service.d
            sudo tee /etc/systemd/system/"${{ env.SERVICE }}".service.d/env.conf >/dev/null <<'EOF'
            [Service]
            EnvironmentFile=/opt/meer-dev/.env
            Environment=FIREBASE_ENABLED=true
            Environment=FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
            Environment=GOOGLE_APPLICATION_CREDENTIALS=/opt/meer-dev/firebase-service-account.json
            Environment=STORAGE_GCS_CREDENTIALS_PATH=/opt/meer-dev/gcs-service-account.json
            EOF
            sudo systemctl daemon-reload

            # Write Google credentials (used by Firebase)
            google_cred_path="${GOOGLE_APPLICATION_CREDENTIALS:-/opt/meer-dev/firebase-service-account.json}"
            sudo mkdir -p "$(dirname "$google_cred_path")"
            echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON_B64 }}" | tr -d '\r\n\t ' | base64 --decode | sudo tee "$google_cred_path" >/dev/null
            sudo chown meerdev:meerdev "$google_cred_path"
            sudo chmod 600 "$google_cred_path"

            # Write GCS credentials (used by Storage)
            gcs_cred_path="/opt/meer-dev/gcs-service-account.json"
            if [ -n "${{ secrets.GCS_SERVICE_ACCOUNT_JSON_B64 }}" ]; then
              sudo mkdir -p "$(dirname "$gcs_cred_path")"
              echo "${{ secrets.GCS_SERVICE_ACCOUNT_JSON_B64 }}" | tr -d '\r\n\t ' | base64 --decode | sudo tee "$gcs_cred_path" >/dev/null
              sudo chown meerdev:meerdev "$gcs_cred_path"
              sudo chmod 600 "$gcs_cred_path"
            fi

            # --- PRE-WARMING STEP ---
            echo "Starting pre-warming on port 8099..."
            # Run the new JAR in background on a temp port to verify health and prime the cache
            sudo -u meerdev bash -c "set -a; source /opt/meer-dev/.env; set +a; export SERVER_PORT=8099; export GOOGLE_APPLICATION_CREDENTIALS=$google_cred_path; export STORAGE_GCS_CREDENTIALS_PATH=$gcs_cred_path; java -jar ${{ env.REMOTE_JAR }} > /tmp/meer-prewarm.log 2>&1 &"
            
            PREWARM_PID=$!
            
            # Wait for health check on pre-warm port
            echo "Waiting for pre-warm instance to be healthy..."
            SUCCESS=0
            for i in {1..30}; do
              if curl -s http://localhost:8099/actuator/health | grep -q '"status":"UP"'; then
                echo "Pre-warm instance is healthy!"
                SUCCESS=1
                break
              fi
              echo "Waiting... ($i/30)"
              sleep 5
            done

            # Kill the pre-warm instance
            sudo kill $PREWARM_PID || true
            sleep 2

            if [ $SUCCESS -eq 1 ]; then
              echo "Performing fast swap..."
              sudo systemctl restart "${{ env.SERVICE }}"
            else
              echo "Pre-warming failed! Check /tmp/meer-prewarm.log"
              sudo tail -n 50 /tmp/meer-prewarm.log
              exit 1
            fi

      - name: Cleanup temp artifacts on dev host
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            sudo rm -f /tmp/meer-*.jar /tmp/.env /tmp/.env/.env || true

      - name: Smoke test (health)
        if: ${{ success() }}
        run: |
          for i in {1..40}; do
            status=$(curl -sSL -o /tmp/health.json -w "%{http_code}" "${{ env.HEALTH_URL }}") || true
            if [ "$status" = "200" ] && grep -q '"status"[[:space:]]*:[[:space:]]*"UP"' /tmp/health.json; then
              cat /tmp/health.json
              exit 0
            fi
            sleep 5
          done
          echo "Health check failed (status=$status)" >&2
          cat /tmp/health.json || true
          exit 1
